---
- name: Check for Homebrew in Apple Silicon location
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: brew_opt

- name: Check for Homebrew in Intel macOS location
  ansible.builtin.stat:
    path: /usr/local/bin/brew
  register: brew_usr_local

- name: Install Homebrew if missing
  ansible.builtin.shell:
    cmd: NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  when: not brew_opt.stat.exists and not brew_usr_local.stat.exists

- name: Set Homebrew prefix fact on macOS
  ansible.builtin.set_fact:
    macos_homebrew_prefix: "{{ '/opt/homebrew' if brew_opt.stat.exists else '/usr/local' }}"

- name: Ensure Homebrew taps are configured on macOS
  community.general.homebrew_tap:
    name: "{{ homebrew_taps | default([]) }}"
    state: present
  when: homebrew_taps | default([]) | length > 0
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Ensure Homebrew formula packages are installed
  community.general.homebrew:
    name: "{{ macos_brew_packages | default([]) }}"
    state: present
  when: macos_brew_packages | default([]) | length > 0
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Ensure python3 shim exists for gcloud-cli installer
  ansible.builtin.file:
    src: "{{ macos_homebrew_prefix }}/opt/python@3.13/libexec/bin/python"
    dest: "{{ macos_homebrew_prefix }}/opt/python@3.13/libexec/bin/python3"
    state: link
    force: false
  when:
    - "'gcloud-cli' in (macos_cask_packages | default([]))"
    - "'python@3.13' in (macos_brew_packages | default([]))"

- name: Check installed fnm Node.js versions on macOS
  ansible.builtin.command:
    cmd: fnm list
  register: fnm_macos_installed_versions
  changed_when: false
  when: "'fnm' in (macos_brew_packages | default([]))"
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Install configured Node.js version with fnm on macOS
  ansible.builtin.command:
    cmd: "fnm install {{ fnm_node_version }}"
  when:
    - "'fnm' in (macos_brew_packages | default([]))"
    - "('v' ~ fnm_node_version) not in (fnm_macos_installed_versions.stdout | default(''))"
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Check current fnm default Node.js version on macOS
  ansible.builtin.command:
    cmd: fnm default
  register: fnm_macos_default_version
  changed_when: false
  failed_when: false
  when: "'fnm' in (macos_brew_packages | default([]))"
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Set configured Node.js version as fnm default on macOS
  ansible.builtin.command:
    cmd: "fnm default {{ fnm_node_version }}"
  when:
    - "'fnm' in (macos_brew_packages | default([]))"
    - fnm_macos_default_version.rc | default(1) != 0 or ((fnm_macos_default_version.stdout | default('') | trim) not in [fnm_node_version, 'v' ~ fnm_node_version])
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Ensure Homebrew cask packages are installed
  community.general.homebrew_cask:
    name: "{{ macos_cask_packages | default([]) }}"
    state: present
  when: macos_cask_packages | default([]) | length > 0
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Check if Oh My Posh font is already installed on macOS
  ansible.builtin.find:
    paths: "{{ ansible_facts['env']['HOME'] }}/Library/Fonts"
    patterns: "*{{ oh_my_posh_font | default('meslo') | capitalize }}*"
    file_type: file
  register: oh_my_posh_macos_font_files
  when: oh_my_posh_install_font | default(true)

- name: Install Oh My Posh font on macOS
  ansible.builtin.command:
    cmd: "oh-my-posh font install {{ oh_my_posh_font | default('meslo') }}"
  when:
    - oh_my_posh_install_font | default(true)
    - oh_my_posh_macos_font_files.matched | default(0) == 0
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"
