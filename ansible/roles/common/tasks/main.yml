---
- name: Install common packages on Linux
  ansible.builtin.package:
    name: "{{ common_packages | default([]) }}"
    state: present
  become: true
  when: ansible_system == "Linux" and (common_packages | default([]) | length > 0)

- name: Install common packages on macOS with Homebrew
  community.general.homebrew:
    name: "{{ common_packages | default([]) }}"
    state: present
  when: ansible_system == "Darwin" and (common_packages | default([]) | length > 0)
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"

- name: Install chezmoi on macOS with Homebrew
  community.general.homebrew:
    name: chezmoi
    state: present
  when: ansible_system == "Darwin"
  environment:
    PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"

- name: Install chezmoi on Linux
  ansible.builtin.shell:
    cmd: sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "{{ ansible_env.HOME }}/.local/bin"
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/chezmoi"
  when: ansible_system == "Linux"

- name: Set Go distribution OS
  ansible.builtin.set_fact:
    go_dist_os: "{{ 'darwin' if ansible_system == 'Darwin' else 'linux' }}"
  when: ansible_system in ["Darwin", "Linux"]

- name: Set Go distribution architecture
  ansible.builtin.set_fact:
    go_dist_arch: "{{ go_arch_map[ansible_architecture] }}"
  vars:
    go_arch_map:
      x86_64: amd64
      amd64: amd64
      arm64: arm64
      aarch64: arm64
  when:
    - ansible_system in ["Darwin", "Linux"]
    - ansible_architecture in ["x86_64", "amd64", "arm64", "aarch64"]

- name: Fail when architecture is unsupported for Go tarball install
  ansible.builtin.fail:
    msg: "Unsupported architecture for Go install: {{ ansible_architecture }}"
  when:
    - ansible_system in ["Darwin", "Linux"]
    - ansible_architecture not in ["x86_64", "amd64", "arm64", "aarch64"]

- name: Ensure Go install root exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/go"
    state: directory
    mode: "0755"
  when: ansible_system in ["Darwin", "Linux"]

- name: Check whether selected Go version is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.local/go/go{{ go_version }}/bin/go"
  register: go_version_installed
  when: ansible_system in ["Darwin", "Linux"]

- name: Create temporary directory for Go extraction
  ansible.builtin.tempfile:
    state: directory
    prefix: go-install-
  register: go_extract_tmp
  when:
    - ansible_system in ["Darwin", "Linux"]
    - not go_version_installed.stat.exists

- name: Download Go archive
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ go_version }}.{{ go_dist_os }}-{{ go_dist_arch }}.tar.gz"
    dest: "{{ go_extract_tmp.path }}/go{{ go_version }}.tar.gz"
    mode: "0644"
  when:
    - ansible_system in ["Darwin", "Linux"]
    - not go_version_installed.stat.exists

- name: Extract Go archive
  ansible.builtin.unarchive:
    src: "{{ go_extract_tmp.path }}/go{{ go_version }}.tar.gz"
    dest: "{{ go_extract_tmp.path }}"
    remote_src: true
  when:
    - ansible_system in ["Darwin", "Linux"]
    - not go_version_installed.stat.exists

- name: Install selected Go version
  ansible.builtin.command:
    cmd: "mv {{ go_extract_tmp.path }}/go {{ ansible_env.HOME }}/.local/go/go{{ go_version }}"
    creates: "{{ ansible_env.HOME }}/.local/go/go{{ go_version }}/bin/go"
  when:
    - ansible_system in ["Darwin", "Linux"]
    - not go_version_installed.stat.exists

- name: Point current Go symlink to selected version
  ansible.builtin.file:
    src: "{{ ansible_env.HOME }}/.local/go/go{{ go_version }}"
    dest: "{{ ansible_env.HOME }}/.local/go/current"
    state: link
    force: true
  when: ansible_system in ["Darwin", "Linux"]

- name: Remove temporary Go extraction directory
  ansible.builtin.file:
    path: "{{ go_extract_tmp.path }}"
    state: absent
  when:
    - ansible_system in ["Darwin", "Linux"]
    - not go_version_installed.stat.exists
